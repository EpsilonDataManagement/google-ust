___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Epsilon Site Tag",
  "categories": ["CONVERSIONS", "MARKETING", "ATTRIBUTION"],
  "brand": {
    "id": "github.com_EpsilonDataManagement",
    "displayName": "EpsilonDataManagement",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Epsilon is a global advertising and marketing tech company, and part of Publicis Groupe. We connect advertisers with people to drive performance while keeping consumer privacy at the forefront.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "tagDetails",
    "displayName": "Tag Details",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "GROUP",
        "name": "siteDetails",
        "displayName": "Site Details",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "TEXT",
            "name": "host",
            "displayName": "Domain",
            "simpleValueType": true,
            "help": "The hostname the advertiser is using for the tag. Ex. tag.brandco.com",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "tagPath",
            "displayName": "Reverse Proxy Directory Path",
            "simpleValueType": true,
            "help": "The directory path of the Reverse Proxy. If you are not using a Reverse Proxy integration, leave this field blank.  If you are using a Reverse Proxy, enter the path of the Reverse Proxy (typically /tag_path or the custom path you have setup as the root of your Reverse Proxy)."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "companyDetails",
        "displayName": "Company Details",
        "subParams": [
          {
            "type": "TEXT",
            "name": "dtm_cid",
            "displayName": "Company ID (dtm_cid)",
            "simpleValueType": true,
            "help": "Advertiser identifier.",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "dtm_cmagic",
            "displayName": "Company Magic (dtm_cmagic)",
            "simpleValueType": true,
            "help": "Secondary advertiser identifier.",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "groupStyle": "ZIPPY_OPEN"
      },
      {
        "type": "GROUP",
        "name": "dynamicFields",
        "displayName": "Dynamic Fields",
        "groupStyle": "ZIPPY_OPEN",
        "subParams": [
          {
            "type": "TEXT",
            "name": "dtm_fid",
            "displayName": "Form ID (dtm_fid)",
            "simpleValueType": true,
            "help": "Form identifier. Ex. 101",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "dtm_promo_id",
            "displayName": "Promo ID (dtm_promo_id)",
            "simpleValueType": true,
            "help": "Value that identifies the page type."
          },
          {
            "type": "TEXT",
            "name": "dtm_email_hash",
            "displayName": "Email Hash (dtm_email_hash)",
            "simpleValueType": true,
            "help": "SHA-256 hash of customerâ€™s email address. *Remove leading/trailing spaces and convert email address to lowercase before hashing."
          },
          {
            "type": "TEXT",
            "name": "dtm_user_id",
            "displayName": "User ID (dtm_user_id)",
            "simpleValueType": true,
            "help": "Unique identifier."
          },
          {
            "type": "TEXT",
            "name": "dtmc_tcf_string",
            "displayName": "Consent String",
            "simpleValueType": true,
            "help": "GDPR consent string."
          },
          {
            "type": "PARAM_TABLE",
            "name": "customParameters",
            "displayName": "Custom Parameters",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "key",
                  "displayName": "Parameter Name",
                  "simpleValueType": true
                },
                "isUnique": true
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "value",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "help": "Custom parameters to be added if advised by Epsilon. Parameters will be added at the end of the query string.",
            "newRowButtonText": "Add Parameter"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "advancedProperties",
        "displayName": "Advanced Properties",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "TEXT",
            "name": "dtm_cookie_id",
            "simpleValueType": true,
            "displayName": "Client Supplied ID (dtm_cookie_id)",
            "help": "Unique first-party cookie ID"
          },
          {
            "type": "RADIO",
            "name": "enableAdvanced",
            "displayName": "Enable Advanced Properties",
            "radioItems": [
              {
                "value": 0,
                "displayValue": "Disabled"
              },
              {
                "value": 1,
                "displayValue": "Enabled"
              }
            ],
            "simpleValueType": true,
            "defaultValue": 0
          },
          {
            "type": "RADIO",
            "name": "enableSPA",
            "displayName": "SPA Support (dtm_clear_tag)",
            "radioItems": [
              {
                "value": 0,
                "displayValue": "Disabled"
              },
              {
                "value": 1,
                "displayValue": "Enabled"
              }
            ],
            "simpleValueType": true,
            "defaultValue": 0
          },
          {
            "type": "RADIO",
            "name": "integrationType",
            "displayName": "Integration Type",
            "radioItems": [
              {
                "value": 0,
                "displayValue": "Default"
              },
              {
                "value": 1,
                "displayValue": "Limited"
              }
            ],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "enableAdvanced",
                "paramValue": 1,
                "type": "EQUALS"
              }
            ],
            "defaultValue": 0,
            "help": "Limited integrations should only be used if specified by Epsilon."
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "pageVisitProperties",
    "displayName": "Page Visit Properties",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "dtmc_department",
        "displayName": "Department (dtmc_department)",
        "simpleValueType": true,
        "help": "The department name for the current page. (Men, Women, Children, etc.)"
      },
      {
        "type": "TEXT",
        "name": "dtmc_category",
        "displayName": "Category (dtmc_category)",
        "simpleValueType": true,
        "help": "The category name for the current page. (Clothing, Accessories, etc.)"
      },
      {
        "type": "TEXT",
        "name": "dtmc_sub_category",
        "displayName": "Subcategory (dtmc_sub_category)",
        "simpleValueType": true,
        "help": "The subcategory name for the current page. (Sweaters, Tops, Bottoms, etc.)"
      },
      {
        "type": "TEXT",
        "name": "dtmc_brand",
        "displayName": "Brand (dtmc_brand)",
        "simpleValueType": true,
        "help": "Manufacturer brand."
      },
      {
        "type": "TEXT",
        "name": "dtmc_product_id",
        "displayName": "Product ID (dtmc_product_id)",
        "simpleValueType": true,
        "help": "Product ID for current product."
      },
      {
        "type": "TEXT",
        "name": "dtmc_upc",
        "displayName": "UPC (dtmc_upc)",
        "simpleValueType": true,
        "help": "Manufacturer UPC code."
      },
      {
        "type": "TEXT",
        "name": "dtmc_mpn",
        "displayName": "Model Part Number (dtmc_mpn)",
        "simpleValueType": true,
        "help": "Manufacturer Model Part Number."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionProperties",
    "displayName": "Conversion Properties",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "dtmc_transaction_id",
        "displayName": "Transaction ID (dtmc_transaction_id)",
        "simpleValueType": true,
        "help": "Client system\u0027s unique identifier for each conversion."
      },
      {
        "type": "TEXT",
        "name": "dtm_conv_val",
        "displayName": "Conversion Value (dtm_conv_val)",
        "simpleValueType": true,
        "help": "Conversion value."
      },
      {
        "type": "TEXT",
        "name": "dtm_conv_curr",
        "displayName": "Conversion Currency (dtm_conv_curr)",
        "simpleValueType": true,
        "help": "ISO currency code (EUR, USD)."
      },
      {
        "type": "TEXT",
        "name": "dtmc_conv_type",
        "displayName": "Conversion Type (dtmc_conv_type)",
        "simpleValueType": true,
        "help": "Differentiate between types of Online Purchases: Delivery, Pickup, etc."
      },
      {
        "type": "TEXT",
        "name": "dtmc_conv_store_location",
        "displayName": "Conversion Store Location (dtmc_conv_store_location)",
        "simpleValueType": true,
        "help": "For Pickup type conversions, denote the store location of the pickup."
      },
      {
        "type": "TEXT",
        "name": "dtm_items",
        "displayName": "Items (dtm_items)",
        "simpleValueType": true,
        "help": "An array of all items in the conversion. Each item should include the following: product_id: SKU of the item;",
        "textAsList": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const sendPixel = require('sendPixel');
const Object = require('Object');
const JSON = require('JSON');
const getCookieValues = require('getCookieValues');
const encodeUriComponent = require('encodeUriComponent');
const getContainerVersion = require('getContainerVersion');
const queryPermission = require('queryPermission');
const getTimestampMillis = require('getTimestampMillis');
const getUrl = require('getUrl');

// Declare Variables
let baseURL = 'https://' + data.host;
const allowedQueryParameters = ['dtm_cid', 'dtm_cmagic', 'dtm_fid', 'dtm_promo_id', 'dtm_email_hash', 'dtm_user_id', 'dtm_cookie_id', 'dtmc_department', 'dtmc_category', 'dtmc_sub_category', 'dtmc_product_id', 'dtmc_brand', 'dtmc_upc', 'dtmc_mpn', 'dtmc_transaction_id', 'dtm_conv_val', 'dtm_conv_curr', 'dtmc_conv_type', 'dtmc_conv_store_location', 'dtm_items', 'dtmc_tcf_string'];

const cv = getContainerVersion();
const cachebusterValue = cv.containerId + '-' + cv.version + '-' + getTimestampMillis();
const pageUrl = getUrl();
let queryStringParameters;
let dtmToken;
let dtmTokenSC;
let finalURL;

log('data = ', data);

//Checking Integration Type RP or Anycast
const integrationType = function(tagPath) {
  
  //True = RP; False = Anycast
  if (tagPath === undefined) {
    return false;
  } else {
    return true;
  }
};

//Assign URL based on Integration Type
if (integrationType(data.tagPath)) {
  baseURL += data.tagPath;
}

//Assigning query string parameters
Object.entries(data).forEach(dataEntries => {
    if (allowedQueryParameters.indexOf(dataEntries[0]) >= 0 && dataEntries[1]) {
      if (dataEntries[0] === 'dtm_items') {
        dataEntries[1] = JSON.stringify(dataEntries[1]).replace();
      }
      
      if (queryStringParameters  === undefined) {
          queryStringParameters = '?' + dataEntries[0] + '=' + encodeUriComponent(dataEntries[1]);
      } else {
          queryStringParameters += '&' + dataEntries[0] + '=' + encodeUriComponent(dataEntries[1]);
      }
    }
});

//Populating Cookie Parameters
dtmToken = getCookieValues('dtm_token');
dtmTokenSC = getCookieValues('dtm_token_sc');

log('dtm_token: ', dtmToken);
log('dtm_token_sc: ', dtmTokenSC);

if (dtmToken.length > 0) {
  queryStringParameters += '&dtm_token=' + dtmToken[0];
} else if (dtmTokenSC.length > 0) {
  queryStringParameters += '&dtm_token=' + dtmTokenSC[0];
}

if (dtmTokenSC.length > 0) {
  queryStringParameters += '&dtm_token_sc=' + dtmTokenSC[0];
}

// dtmc_loc
queryStringParameters += '&dtmc_loc=' + encodeUriComponent(pageUrl);

//dtm_clear_tag
if (data.enableSPA == 1) {
  queryStringParameters += '&dtm_clear_tag=all';
}

//Populating dtmc_tms query parameter
queryStringParameters += '&dtmc_tms=4';

//Populating Cachebuster query parameter
queryStringParameters += '&cachebuster=' + cachebusterValue;

//Populating Additional query parameters (with override logic for default parameters)
if (data.customParameters) {
  data.customParameters.forEach(paramObj => {
    const key = paramObj.key;
    const value = paramObj.value;
    if (key && value) {
      const encodedValue = encodeUriComponent(value);
      
      if (queryStringParameters.indexOf(key + '=') >= 0) {
        const paramIndex = queryStringParameters.indexOf(key + '=');
        const endIndex = queryStringParameters.indexOf('&', paramIndex);
        const oldParam = queryStringParameters.substring(paramIndex, endIndex > 0 ? endIndex : queryStringParameters.length);
        queryStringParameters = queryStringParameters.replace(oldParam, key + '=' + encodedValue);
      } else {
        if (queryStringParameters === undefined || queryStringParameters === '') {
          queryStringParameters = '?' + key + '=' + encodedValue;
        } else {
          queryStringParameters += '&' + key + '=' + encodedValue;
        }
      }
    }
  });
}

log('queryParameters = ', queryStringParameters);

const onSuccess = function() {
  log('Script loaded successfully: ' + baseURL);
  data.gtmOnSuccess();
};
const onFailure = function() {
  log('Script load failed: ' + baseURL);
  data.gtmOnFailure();
};

//Launch Tag
if (data.integrationType === 0 || !data.integrationType) {
  if (queryPermission('inject_script', baseURL)) {
    //Javascript Tag
    finalURL = baseURL + '/profile/visit/js/1_0' + queryStringParameters;
    injectScript(finalURL, onSuccess, onFailure);
  } else {
    log('Invalid permission to load script from: ', baseURL);
    data.gtmOnFailure();
  }
} else {
  //Pixel Tag
  finalURL = baseURL + '/profile/visit/px/1_0' + queryStringParameters;
  sendPixel(finalURL, onSuccess, onFailure);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.dotomi.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 11/29/2022, 2:32:00 PM
